sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox"],function(e,r){"use strict";return e.extend("emlatracker.csvupload.ext.main.Main",{onInit:function(){this._selectedFile=null;this._updateUploadButtonState()},onFileChange:function(e){var r=e.getParameter("files")&&e.getParameter("files")[0];this._selectedFile=r||null;if(r)this._showMessage("File selected: "+r.name,"Information");this._updateUploadButtonState()},onCsvTypeChange:function(){this._updateUploadButtonState()},_updateUploadButtonState:function(){var e=this.byId("csvTypeRadio");var r=e&&typeof e.getSelectedIndex==="function"&&e.getSelectedIndex()!==-1;this.byId("uploadButton").setEnabled(!!this._selectedFile&&r)},onUploadPress:function(){if(!this._selectedFile){this._showMessage("Please select a CSV file first.","Error");return}var e=this.byId("csvTypeRadio");var r=e&&typeof e.getSelectedIndex==="function"?e.getSelectedIndex():-1;var t=r===0?"integration":r===1?"public":null;if(!t){this._showMessage("Please choose a CSV type","Error");return}var n=this;var o=new FileReader;o.onload=function(e){n.byId("uploadButton").setEnabled(false);n._uploadViaHTTP(e.target.result,t)};o.onerror=function(e){console.error("File read error",e);n._showMessage("Failed to read file","Error")};o.readAsText(this._selectedFile,"UTF-8")},_uploadViaHTTP:function(e,r){var t=this.getView().getModel();if(!t)return Promise.reject(new Error("No OData model"));var n=this;function o(e){var r=[],t="",n=false;for(var o=0;o<e.length;o++){var s=e[o];if(s==='"'){if(n&&o+1<e.length&&e[o+1]==='"'){t+='"';o++;continue}n=!n;t+=s;continue}if(!n&&(s==="\n"||s==="\r")){if(s==="\r"&&o+1<e.length&&e[o+1]==="\n"){}if(t.trim().length>0)r.push(t);t="";continue}t+=s}if(t.trim().length>0)r.push(t);return r}var s=o(e);if(s.length===0){n._showMessage("CSV file is empty","Error");return Promise.reject(new Error("Empty"))}var a=s[0];var i=s.slice(1);var l=i.length;var d=9e4,u=250;function c(e,r){var t=[],n=[],o=e.length+1,s=o;for(var a=0;a<r.length;a++){var i=r[a],l=i.length+1;if(n.length>0&&(s+l>d||n.length>=u)){t.push(e+"\n"+n.join("\n"));n=[];s=o}if(l+o>d&&n.length===0){t.push(e+"\n"+i);continue}n.push(i);s+=l}if(n.length>0)t.push(e+"\n"+n.join("\n"));return t}var p=c(a,i);p.forEach(function(e,r){console.log("Prepared batch",r+1,"/",p.length,"size="+e.length+" bytes")});n._showMessage("Processing "+l+" rows in "+p.length+" batches...","Information");var h={inserted:0,updated:0,updateErrors:0,errors:[],failedRowsCsv:"",skippedNoAdvisor:0,validationErrors:0,dbErrors:0,advisorUnresolved:0};var f=0;function v(e){if(e>=p.length){n._handleUploadResponse(h);return Promise.resolve(h)}f=e+1;n._showMessage("Batch "+f+" of "+p.length+" - uploading...","Information");return new Promise(function(n,o){try{var s=t.bindContext("/uploadCSV(...)",undefined,{groupId:"$direct"});s.setParameter("csvData",p[e]);if(r)s.setParameter("csvType",r);s.execute().then(function(){try{var e=s.getBoundContext().getObject();var r;if(e&&typeof e.value==="string"){try{r=JSON.parse(e.value)}catch(t){r={message:e.value,inserted:0,errors:[]}}}else if(e&&e.value){r=e.value}else{r=e}h.inserted+=r.inserted||0;h.updated+=r.updated||0;h.updateErrors+=r.updateErrors||0;h.skippedNoAdvisor+=r.skippedNoAdvisor||0;h.validationErrors+=r.validationErrors||0;h.dbErrors+=r.dbErrors||0;h.advisorUnresolved+=r.advisorNotFoundCount||0;if(r.errors&&r.errors.length)h.errors=h.errors.concat(r.errors);if(r.failedRowsCsv)h.failedRowsCsv+=r.failedRowsCsv+"\n";n()}catch(e){console.error("Parse response error",e);o(e)}}).catch(function(e){console.error("Action error batch "+f,e);o(e)})}catch(e){console.error("Config action error",e);o(e)}}).then(function(){return v(e+1)})}return v(0).catch(function(e){var r="Upload failed";if(e&&e.message)r+=": "+e.message;n._showMessage(r,"Error");if(h.inserted>0||h.errors.length>0)n._handleUploadResponse(h);return Promise.reject(e)})},_handleUploadResponse:function(e){var r=e&&(e.inserted||e.insertedCount||0)||0;var t=e&&e.updated||0;var n=e&&e.updateErrors||0;var o=e&&e.errors||[];var s=e&&e.failedRowsCsv;var a=e&&e.skippedNoAdvisor||0;var i=e&&(e.advisorUnresolved||e.advisorNotFoundCount)||0;this._showMessage("Upload finished. Inserted: "+r+", Updated: "+t+", Errors: "+o.length+(a?", Skipped (no advisor): "+a:"")+(i?", Advisor unresolved: "+i:"")+(n?", UpdateErrors: "+n:""),"Success");var l=this;var d=[new sap.m.Text({text:"Inserted: "+r}),new sap.m.Text({text:"Updated: "+t}),new sap.m.Text({text:"Errors: "+o.length}),n?new sap.m.Text({text:"Update Errors: "+n}):null,a?new sap.m.Text({text:"Skipped (no advisor): "+a}):null,i?new sap.m.Text({text:"Advisor Unresolved: "+i}):null].filter(Boolean);if(o.length===0){d.push(new sap.m.Text({text:"No errors encountered."}))}var u=new sap.m.VBox({items:d});var c=null;if(o.length){c=new sap.m.Table({headerText:"Error Details",columns:[new sap.m.Column({header:new sap.m.Label({text:"Row"})}),new sap.m.Column({header:new sap.m.Label({text:"Reason"})}),new sap.m.Column({header:new sap.m.Label({text:"Raw"})})]});o.forEach(function(e){var r="";try{r=e.raw?JSON.stringify(e.raw):e.record?JSON.stringify(e.record):""}catch(e){r=""}c.addItem(new sap.m.ColumnListItem({cells:[new sap.m.Text({text:e.row!=null?e.row:""}),new sap.m.Text({text:e.reason||e.__dbError||""}),new sap.m.Text({text:r})]}))})}var p=[u];if(c)p.push(c);var h=new sap.m.Dialog({title:"Upload Result",contentWidth:"70%",content:p,beginButton:new sap.m.Button({text:"Close",press:function(){h.close()}}),endButton:new sap.m.Button({text:"Download Errors",type:"Emphasized",press:function(){if(!o.length){l._showMessage("No errors to download","Information");return}var e="";if(s){e=s}else{e="row,reason,raw\n";o.forEach(function(r){var t="";try{t=r.raw?JSON.stringify(r.raw):r.record?JSON.stringify(r.record):""}catch(e){t=""}e+=(r.row||"")+","+'"'+(r.reason||r.__dbError||"").replace(/"/g,'""')+'"'+","+'"'+t.replace(/"/g,'""')+'"'+"\n"})}var r=new Blob([e],{type:"text/csv;charset=utf-8;"});var t=URL.createObjectURL(r);var n=document.createElement("a");n.href=t;n.download="upload-errors.csv";document.body.appendChild(n);n.click();document.body.removeChild(n);URL.revokeObjectURL(t)}}),afterClose:function(){h.destroy()}});h.open()},_showMessage:function(e,r){var t=this.byId("messageStrip");if(!t)return;t.setText(e);t.setType(r||"Information");t.setVisible(true)}})});
//# sourceMappingURL=Main.controller.js.map