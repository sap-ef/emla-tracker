sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,r){"use strict";return e.extend("emlatracker.csvupload.ext.main.Main",{onInit:function(){this._selectedFile=null;this._updateUploadButtonState();var e=this.getView().getModel();console.log("Model instance:",e);console.log("Is OData V4 model?",e instanceof sap.ui.model.odata.v4.ODataModel);if(e){console.log("Available methods on model:",Object.keys(e))}setTimeout(function(){var e=this.getView&&this.getView().getModel&&this.getView().getModel()||this.getOwnerComponent&&this.getOwnerComponent().getModel&&this.getOwnerComponent().getModel();console.log("Model available:",!!e);try{if(e&&e.getMetadata){console.log("Model type:",e.getMetadata().getName())}}catch(e){console.log("Model metadata not available")}}.bind(this),1e3)},onFileChange:function(e){var t=e.getSource();var r=e.getParameter("files")&&e.getParameter("files")[0];if(r){this._selectedFile=r;this._showMessage("File selected: "+r.name,"Information")}else{this._selectedFile=null}this._updateUploadButtonState()},onCsvTypeChange:function(e){this._updateUploadButtonState();var t=e.getParameter("selectedIndex");var r=null;if(t===0)r="integration";else if(t===1)r="public";if(r){var a=this.byId(t===0?"rbIntegration":"rbPublic").getText();this._showMessage("CSV type selected: "+a,"Information")}},_updateUploadButtonState:function(){var e=!!this._selectedFile;var t=this.byId("csvTypeRadio");var r=t&&typeof t.getSelectedIndex==="function"&&t.getSelectedIndex()!==-1;this.byId("uploadButton").setEnabled(e&&r)},onUploadPress:function(){if(!this._selectedFile){this._showMessage("Please select a CSV file first.","Error");return}var e=this.byId("csvTypeRadio");var t=e&&typeof e.getSelectedIndex==="function"?e.getSelectedIndex():-1;var r=t===0?"integration":t===1?"public":null;if(!r){this._showMessage("Please choose a CSV type","Error");return}var a=this;var o=new FileReader;o.onload=function(e){var t=e.target.result;a._showMessage("Uploading CSV...","Information");try{a.byId("uploadButton").setEnabled(false)}catch(e){}a._uploadViaHTTP(t,r)};o.onerror=function(e){console.error("File read error",e);a._showMessage("Failed to read file: "+(e&&e.message?e.message:String(e)),"Error")};o.readAsText(this._selectedFile,"UTF-8")},_uploadCSVData:function(e){var t=this;console.log("Entering _uploadCSVData, this.getModel exists? ->",typeof this.getModel);var r=null;var a=this.byId("csvTypeRadio");if(a&&typeof a.getSelectedIndex==="function"){var o=a.getSelectedIndex();if(o===0)r="integration";else if(o===1)r="public"}var n=this.byId("delimiterSelect").getSelectedKey();if(n==="tab"){n="\t"}var s=this.byId("hasHeaderCheckBox").getSelected();var i=this._parseCSV(e,n,s,r);if(!i){return}this._showMessage("Uploading "+i.length+" records ("+r+" format)...","Information");var l=this._arrayToCSV(i,r);try{this._uploadViaHTTP(l)}catch(e){console.error("Upload failed (HTTP fallback):",e);t._showMessage("Upload failed: "+e.message,"Error")}},_uploadViaHTTP:function(e,t){var r=this;var a=this.getView().getModel();if(!a){r._showMessage("OData model not available","Error");return Promise.reject(new Error("No OData model"))}console.log("Model service URL:",a.getServiceUrl());console.log("Model type:",a.getMetadata().getName());var o=e.split(/\r?\n/).filter(function(e){return e.trim().length>0});if(o.length===0){r._showMessage("CSV file is empty","Error");return Promise.reject(new Error("Empty CSV"))}var n=o[0];var s=o.slice(1);var i=s.length;var l=100;var c=[];for(var d=0;d<s.length;d+=l){var u=s.slice(d,Math.min(d+l,s.length));var f=n+"\n"+u.join("\n");c.push(f)}console.log("Processing "+i+" rows in "+c.length+" batches");r._showMessage("Processing "+i+" rows in "+c.length+" batches...","Information");var g={inserted:0,errors:[],failedRowsCsv:""};var h=0;function p(e){if(e>=c.length){console.log("All batches processed. Total inserted:",g.inserted);r._handleUploadResponse(g);return Promise.resolve(g)}h=e+1;var o="Batch "+h+" of "+c.length;console.log(o);r._showMessage(o+" - uploading...","Information");return new Promise(function(r,o){try{var n=a.bindContext("/uploadCSV(...)");n.setParameter("csvData",c[e]);if(t){n.setParameter("csvType",t)}n.execute().then(function(){try{var e=n.getBoundContext().getObject();console.log("Batch "+h+" response:",e);var t;if(e&&typeof e.value==="string"){try{t=JSON.parse(e.value)}catch(r){t={message:e.value,inserted:0,errors:[]}}}else if(e&&e.value){t=e.value}else{t=e}g.inserted+=t.inserted||0;if(t.errors&&t.errors.length>0){g.errors=g.errors.concat(t.errors)}if(t.failedRowsCsv){g.failedRowsCsv+=t.failedRowsCsv+"\n"}r()}catch(e){console.error("Error parsing batch response",e);o(e)}}).catch(function(e){console.error("Batch "+h+" error:",e);o(e)})}catch(e){console.error("Error setting up batch call:",e);o(e)}}).then(function(){return p(e+1)})}return p(0).catch(function(e){console.error("Batch processing error:",e);var t="Upload failed";if(e&&e.message){t+=": "+e.message}else if(e&&e.error&&e.error.message){t+=": "+e.error.message}r._showMessage(t,"Error");if(g.inserted>0||g.errors.length>0){r._handleUploadResponse(g)}return Promise.reject(e)})},_handleUploadResponse:function(e){var t=this;var r=e&&(e.inserted||e.insertedCount||0)||0;var a=e&&e.errors||[];var o=e&&e.failedRowsCsv;t._showMessage("Upload finished. Inserted: "+r+", Errors: "+(a.length||0),"Success");var n=new sap.m.VBox({items:[new sap.m.Text({text:"Inserted: "+r}),new sap.m.Text({text:"Errors: "+(a.length||0)})],renderType:"Bare",applyContentPadding:true});var s=null;if(a&&a.length>0){s=new sap.m.Table({headerText:"Error details",inset:false,growing:false,columns:[new sap.m.Column({header:new sap.m.Label({text:"Row"})}),new sap.m.Column({header:new sap.m.Label({text:"Reason"})}),new sap.m.Column({header:new sap.m.Label({text:"Raw"})})]});a.forEach(function(e){var t="";try{t=e.raw?JSON.stringify(e.raw):""}catch(r){t=String(e.raw)}var r=new sap.m.ColumnListItem({cells:[new sap.m.Text({text:e.row||""}),new sap.m.Text({text:e.reason||e.__dbError||""}),new sap.m.Text({text:t})]});s.addItem(r)})}var i=new sap.m.Panel({backgroundDesign:"Transparent",width:"100%",content:s?[n,s]:[n]});var l=new sap.m.Dialog({title:"Upload result",contentWidth:"70%",content:[i],beginButton:new sap.m.Button({text:"Close",press:function(){l.close()}}),endButton:new sap.m.Button({text:"Download Errors",type:"Emphasized",press:function(){if(o){var e=new Blob([o],{type:"text/csv;charset=utf-8;"});var r=URL.createObjectURL(e);var n=document.createElement("a");n.href=r;n.download="upload-errors.csv";document.body.appendChild(n);n.click();document.body.removeChild(n);URL.revokeObjectURL(r);return}if(!a||a.length===0){t._showMessage("No errors to download","Information");return}var s="row,reason,raw\n";a.forEach(function(e){var t=e.raw?JSON.stringify(e.raw).replace(/"/g,'""'):"";s+=(e.row||"")+","+'"'+(e.reason||e.__dbError||"")+'"'+","+'"'+t+'"'+"\n"});var e=new Blob([s],{type:"text/csv;charset=utf-8;"});var r=URL.createObjectURL(e);var n=document.createElement("a");n.href=r;n.download="upload-errors.csv";document.body.appendChild(n);n.click();document.body.removeChild(n);URL.revokeObjectURL(r)}}),afterClose:function(){l.destroy()}});l.open()},_parseCSV:function(e,t,r,a){try{var o=e.split(/\r?\n/).map(function(e){return e.trim()}).filter(function(e){return e.length>0});if(o.length===0){this._showMessage("CSV file is empty","Error");return null}var n=[];var s=[];if(!t){var i=o[0];var l=[",",";","|","\t"];var c={};l.forEach(function(e){c[e]=0});var d=false;for(var u=0;u<i.length;u++){var f=i[u];if(f==='"'){d=!d}if(!d&&l.indexOf(f)!==-1){c[f]++}}t=l[0];var g=-1;l.forEach(function(e){if(c[e]>g){g=c[e];t=e}})}for(var h=0;h<o.length;h++){var p=this._parseCSVLine(o[h],t);if(h===0&&r){s=p.map(function(e){return e&&e.toString().trim()});continue}if(r&&p.length!==s.length){this._showMessage("Row "+(h+1)+": Column count mismatch","Error");return null}n.push(p)}if(!r&&n.length>0){s=n[0].map(function(e,t){return"Column"+(t+1)})}var m=function(e){if(!e)return"";return e.toString().trim().toLowerCase().replace(/\s+/g," ")};var v=s.map(m);var w={"account name":"customerName",opp_accountname:"customerName",accountname:"customerName","erp cust number":"customerNumber","erp cust no":"customerNumber","product list":"emlaType",productlist:"emlaType","emla staffing for btp":"btpOnbAdvNome","btp onb advisor":"btpOnbAdvNome","btp onb advisor email":"btpOnbAdvEmail","btp onboard advisor email":"btpOnbAdvEmail","emla staffing for sap cloud erp":"erpOnbAdvNome","region lvl 1":"region","region lvl 2":"region","region l5/country":"country","region l5/country":"country","revenue start date":"startDate","contract start date (line item)":"startDate","contract start date":"startDate"};var b;if(a==="integration"){b=["customerName","customerNumber","emlaType","region","country"]}else if(a==="public"){b=["customerName","customerNumber","emlaType"]}else{b=["customerName","customerNumber","emlaType"]}var y=v.map(function(e){return w[e]||(b.indexOf(e)!==-1?e:null)}).filter(function(e){return e});var _=b.filter(function(e){return y.indexOf(e)===-1});if(_.length>0){this._showMessage("Missing required headers for "+a+" CSV: "+_.join(", "),"Error");return null}return n}catch(e){this._showMessage("CSV parsing error: "+e.message,"Error");return null}},_parseCSVLine:function(e,t){var r=[];var a="";var o=false;for(var n=0;n<e.length;n++){var s=e[n];if(s==='"'){if(o&&e[n+1]==='"'){a+='"';n++}else{o=!o}}else if(s===t&&!o){r.push(a);a=""}else{a+=s}}r.push(a);return r},_showMessage:function(e,t){var r=this.byId("messageStrip");r.setText(e);switch(t){case"Success":r.setType("Success");break;case"Error":r.setType("Error");break;case"Information":default:r.setType("Information");break}r.setVisible(true)}})});
//# sourceMappingURL=Main.controller.js.map